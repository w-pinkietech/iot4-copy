# IoTシステム疎結合化プロジェクト - 要件定義書

## 1. 汎用通信Driver Library

### 1.1 UART Driver

**必要性**: BravePIデバイスはUART通信でデータを送信するため、物理層での通信制御が必要。

**要件**:
- Raspberry Pi 4のUARTポート（/dev/ttyAMA0）からデータを読み取る
- ボーレート38400、データビット8、パリティなし、ストップビット1の設定
- 受信した生データをMQTTトピック `raw/uart/data` に配信
- 通信エラー時の自動再接続（30秒間隔でリトライ）

### 1.2 USB Serial Driver  

**必要性**: BraveJIGデバイスはUSB Serial接続で最大10台まで同時接続されるため、複数デバイスの管理が必要。

**要件**:
- /dev/ttyACM0から/dev/ttyACM9までのUSB Serialポートを監視
- デバイスの接続・切断を検出（ホットプラグ対応）
- 各デバイスからの生データを個別のMQTTトピックに配信（例: `raw/usb_serial/{device_id}/data`）
- デバイスIDはシリアル番号またはポート番号から生成

### 1.3 I2C Driver

**必要性**: 温度・湿度・圧力センサーなどのI2Cデバイスからデータを取得するため。

**要件**:
- I2Cバス（/dev/i2c-1）上のデバイスをアドレススキャン（0x00-0x7F）
- 指定されたI2Cアドレスのレジスタを定期的に読み取り
- 読み取り間隔は設定可能（100ms〜10秒）
- 生データをMQTTトピック `raw/i2c/{address}/data` に配信

## 2. Universal Gateway

### 2.1 MQTT Subscriber

**必要性**: 汎用通信Driverから配信される生データを受信し、プロトコル変換の入力とするため。

**要件**:
- MQTTブローカーに接続し、`raw/+/+/data` パターンのトピックを購読
- QoS 1での受信保証
- 接続断時のメッセージバッファリング（最大10,000メッセージ）
- 自動再接続機能

### 2.2 プラグイン管理システム

**必要性**: 新規ハードウェアへの対応を容易にし、システム停止なしに機能追加を可能にするため。

**要件**:
- `plugins/` ディレクトリ内のPythonファイルを自動検出
- プラグインの動的ロード・アンロード
- プラグイン設定ファイル（plugin.yaml）の読み込み
- プラグインのエラー時の自動隔離（他のプラグインに影響を与えない）
- プラグインAPIバージョンチェック

### 2.3 データ変換エンジン

**必要性**: 各種ハードウェアからの異なるデータ形式を統一フォーマットに変換し、上位システムでの処理を簡素化するため。

**要件**:
- プラグインが返すデータを統一JSON形式に変換
- 必須フィールドの検証（deviceId、sensorType、value、timestamp）
- 不正なデータの除外とエラーログ記録
- タイムスタンプの正規化（すべてUTC、ISO 8601形式）

## 3. Protocol Adapter Plugins

### 3.1 BravePI Protocol Plugin

**必要性**: 既存のBravePIデバイスとの互換性を維持し、現行システムからの移行を可能にするため。

**要件**:
- BravePIバイナリプロトコルのフレーム解析
- プロトコルバイト（0x10）、メッセージタイプの識別
- 16種類のセンサータイプ（温度、湿度、照度、接点入力等）のデータ抽出
- CRC16チェックサムによるデータ整合性検証
- エラーレスポンス（0xFF）の適切な処理

### 3.2 BraveJIG Protocol Plugin

**必要性**: BraveJIGの高精度センサーや拡張機能をサポートし、既存システムとの互換性を保つため。

**要件**:
- BraveJIG固有のメッセージタイプ（0x02: JIG情報）の処理
- 拡張センサータイプのサポート
- キャリブレーションデータの管理
- デバイス番号（8バイト）からの一意なdeviceId生成

### 3.3 プラグインインターフェース仕様

**必要性**: すべてのプラグインが同一の方法で動作することを保証し、新規プラグイン開発を標準化するため。

**要件**:
- `initialize(config: dict) -> bool`: 初期化処理
- `process(raw_data: bytes, metadata: dict) -> dict`: データ変換処理
- `get_info() -> dict`: プラグイン情報（名前、バージョン、対応プロトコル）
- `health_check() -> bool`: 健全性確認
- `shutdown() -> None`: 終了処理

## 4. 統一API層

### 4.1 REST API

**必要性**: 既存システムや外部アプリケーションがHTTP経由でデータアクセスできるようにするため。

**要件**:
- FastAPIフレームワークによる実装
- センサーデータ取得: `GET /api/v1/devices/{deviceId}/data`
- デバイス一覧取得: `GET /api/v1/devices`
- システム状態確認: `GET /api/v1/system/status`
- JWT認証によるアクセス制御
- レート制限（100リクエスト/分/クライアント）

### 4.2 MQTT Publisher

**必要性**: リアルタイムデータ配信が必要なシステム（SCADA、PLC等）への低遅延データ提供のため。

**要件**:
- 処理済みデータを `processed/{deviceType}/{deviceId}/data` 形式で配信
- QoS 0/1/2の選択可能
- Retained messageによる最新値の保持
- トピック単位でのアクセス制御

## 5. 非機能要件

### 5.1 性能要件

**必要性**: 工場環境での大量センサーデータをリアルタイムに処理するため。

**要件**:
- 10,000メッセージ/秒の処理能力（Raspberry Pi 4、4GB RAM環境）
- 平均レスポンスタイム200ms以下
- メモリ使用量2GB以下
- CPU使用率平均50%以下

### 5.2 信頼性要件

**必要性**: 24時間365日稼働する工場システムでの利用に耐えるため。

**要件**:
- システム稼働率99.9%以上
- 通信断からの自動回復（30秒以内）
- データロスト率0.1%以下
- エラー時の自動リトライ（最大3回）

### 5.3 保守性要件

**必要性**: 長期的な運用と継続的な機能拡張を可能にするため。

**要件**:
- 構造化ログ出力（JSON形式）
- デバッグモードでの詳細ログ
- 設定の外部化（環境変数、設定ファイル）
- プラグインの独立したテスト実行

### 5.4 セキュリティ要件

**必要性**: 工場ネットワークでの不正アクセスやデータ漏洩を防ぐため。

**要件**:
- API認証（JWT、有効期限24時間）
- MQTT認証（ユーザー名/パスワード）
- TLS 1.2以上での通信暗号化（オプション）
- アクセスログの記録と監査

### 5.5 互換性要件

**必要性**: 既存システムからの段階的移行を可能にするため。

**要件**:
- BravePI/JIGの全メッセージタイプをサポート
- 既存のデータベーススキーマへの変換オプション
- レガシーAPIエンドポイントの提供（廃止予定を明示）
- 移行期間中の並行稼働サポート

## 6. 制約事項

### 6.1 技術的制約

- Python 3.9以上（Raspberry Pi OS標準パッケージ）
- 最大同時接続数1,000デバイス（メモリ制約）
- MQTTメッセージサイズ最大256KB
- プラグインファイルサイズ最大10MB

### 6.2 運用上の制約

- 初期実装はRaspberry Pi 4限定
- ネットワーク帯域100Mbps以上推奨
- ストレージ容量最低32GB
- 定期的な再起動（月1回推奨）

---

## 文書情報

- **文書バージョン**: 2.0
- **作成日**: 2025年6月18日
- **最終更新**: 2025年6月18日